---
title: "R Notebook"
## title: "Implementation and Figures: panel_2 and panel_5(ex_fig_2)"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressi_ng *Cmd+Shift+Enter*. 

<!-- sourcing data and function file-->
```{r}
source_rmd <- function(x, ...) {
  library(knitr)
  options(knitr.duplicate.label = 'allow')
  source(purl(x, output = tempfile()), ...)
}
source_rmd("../Tools/s0_Build_Immune_matrix.Rmd")
source_rmd("../Tools/s1_Load_Preprocess_MSKCC.Rmd")
```



<!-- Run s0 and s1 to load and preprocess the data and functions required-->
<!-- Calculate Response difference btw tmb-high vs low group-->
```{r}
allcancer_types=levels(mskcc_combined$Cancer_Type_acronym)

ORR_difference=do.call(rbind, sapply(allcancer_types, function(x)
  err_handle(Calculate_TMB_Response_association(infunc_df= mskcc_combined,
                                                COI=x,
                                                response_measure='ORR')) ))

OS_difference=do.call(rbind, lapply(allcancer_types, function(x)
  err_handle(Calculate_TMB_Response_association(infunc_df= mskcc_combined,
                                                COI=x,
                                                response_measure='OS'))) )
## 1/HR to keep same direction for TMB power
OS_difference <- data.frame(OS_difference)
OS_difference$effect_size= 1/OS_difference$effect_size
rownames(OS_difference)=allcancer_types

PFS_difference=do.call(rbind, lapply(allcancer_types, function(x)
  err_handle(Calculate_TMB_Response_association(infunc_df= mskcc_combined,
                                                COI=x,
                                                response_measure='PFS'))) )
PFS_difference <- data.frame(PFS_difference)
PFS_difference$effect_size= 1/PFS_difference$effect_size
rownames(PFS_difference)=allcancer_types
```
<!-- Figure 2B and extended_figure 2C-->
<!-- Immune determinants of tmb-response association Part 1: ORR-->
```{r}
Fig_ORR_allcancer_types=create_corr_with_Immune_factors(infunc_cancer_types=allcancer_types,
                                                        infunc_immune_matrix=immune_factor,
                                                        infun_Tmb_Resp_Association = ORR_difference,
                                                        response_type='ORR',
                                                        consider_cancer_type='all_cancerTypes',
                                                        infunc_title = 'All Cancer Types')

Fig_ORR_Only_Sig_Tmb.Resp_associated_cancerTypes=create_corr_with_Immune_factors(
                                                infunc_cancer_types=allcancer_types[which(ORR_difference[,2]/2<0.1)],
                                                infunc_immune_matrix=immune_factor,
                                                infun_Tmb_Resp_Association = ORR_difference,
                                                response_type='ORR',
                                                consider_cancer_type='Only_Sig_Tmb.Resp_associated_cancerTypes',
                                                infunc_title = 'Cancer types with Sig Power of TMB')

combined_ORR=ggarrange(Fig_ORR_allcancer_types[[2]], 
                       Fig_ORR_Only_Sig_Tmb.Resp_associated_cancerTypes[[2]], 
                       common.legend = T)
ggsave(paste('../Result_fgures/Fig1A_tmb-ORR_associationVSTME_factors','.pdf', sep ='' ),
       combined_ORR, height=7, width = 12, units = 'in', dpi = 500)

```
<!-- Figure 2A and extended_figure 2B-->
<!-- Immune determinants of tmb-response association Part 2: OS-->
```{r}
Fig_OS_allcancer_types=create_corr_with_Immune_factors(infunc_cancer_types=allcancer_types,
                                infunc_immune_matrix=immune_factor,
                                infun_Tmb_Resp_Association = OS_difference,
                                response_type='OS',
                                consider_cancer_type='all_cancerTypes',
                                infunc_title = 'All Cancer Types')

Fig_OS_Only_Sig_Tmb.Resp_associated_cancerTypes=create_corr_with_Immune_factors(
  infunc_cancer_types=allcancer_types[which(OS_difference[,2]/2<0.1)],
  infunc_immune_matrix=immune_factor,
  infun_Tmb_Resp_Association = OS_difference,
  response_type='OS',
  consider_cancer_type='Only_Sig_Tmb.Resp_associated_cancerTypes',
  infunc_title = 'Cancer types with Sig tmb-resp Association')

combined_OS=ggarrange(Fig_OS_allcancer_types[[2]], 
                       Fig_OS_Only_Sig_Tmb.Resp_associated_cancerTypes[[2]], 
                       common.legend = T)
ggsave(paste('../Result_fgures/Fig1B_tmb-OS_associationVSTME_factors','.pdf', sep ='' ),
       combined_OS, height=7, width = 12, units = 'in', dpi = 500)


```
<!-- extended_figure 2A-->
<!-- Immune determinants of tmb-response association Part 3: PFS-->
```{r}
Fig_PFS_allcancer_types=create_corr_with_Immune_factors(infunc_cancer_types=allcancer_types,
                                infunc_immune_matrix=immune_factor,
                                infun_Tmb_Resp_Association = PFS_difference,
                                response_type='PFS',
                                consider_cancer_type='all_cancerTypes',
                                infunc_title = 'All Cancer Types')

Fig_PFS_Only_Sig_Tmb.Resp_associated_cancerTypes=create_corr_with_Immune_factors(
  infunc_cancer_types=allcancer_types[which(PFS_difference[,2]/2<0.1)],
  infunc_immune_matrix=immune_factor,
  infun_Tmb_Resp_Association = PFS_difference,
  response_type='PFS',
  consider_cancer_type='Only_Sig_Tmb.Resp_associated_cancerTypes',
  infunc_title = 'Cancer types with Sig tmb-resp Association')
combined_PFS=ggarrange(Fig_PFS_allcancer_types[[2]], 
                       Fig_PFS_Only_Sig_Tmb.Resp_associated_cancerTypes[[2]], 
                       common.legend = T)

ggsave(paste('../Result_fgures//Fig1C_tmb-PFS_associationVSTME_factors', '.pdf', sep ='' ),
       combined_PFS, height=7, width = 12, units = 'in', dpi = 500)
```


<!-- Figure 2D (panel2)-->
```{r}
df2plot=data.frame(allcancer_types,OS_difference[allcancer_types,],
                     immune_factor[allcancer_types,c(22,39,24,37)])
df2plot= na.omit(df2plot)
df2plot= df2plot[is.finite(df2plot$effect_size),]
df2plot$rank= rank(df2plot$effect_size)
df2plot_long= gather(df2plot, modulator_name, abundance,
                      M1.macrophage.:PDL1..combined.positive.score.,factor_key = T )

df2plot_long$modulator_name= ifelse(df2plot_long$modulator_name == "M1.macrophage.", "M1 macrophage", 
                                    ifelse(df2plot_long$modulator_name == "Tumor.purity.", "Tumor purity",
                                           ifelse(df2plot_long$modulator_name == "Resting.dendritic.cells."
                                                  ,"Resting dendritic cells", 
                                                 ifelse(df2plot_long$modulator_name == "Active.dendritic.cells.",
                                                  "Active dendritic cells", "PDL1 combined positive score"))))

df2plot_long$Modulator_type = ifelse(df2plot_long$modulator_name %in% 
                                     c("M1 macrophage","Tumor purity"), 
                                     "Positive modulator", 
                                     "Negative modulator")


# unlist(lapply(split(df2plot_long, df2plot_long$modulator_name), function(x) rank(x[,6])))

df2plot_long= df2plot_long[order(df2plot_long$modulator_name),]
df2plot_long$modulator_rank= unlist(lapply(split(df2plot_long, df2plot_long$modulator_name), function(x) rank(x[,6])))

df2plot_pearson= df2plot_long[!(df2plot_long$allcancer_types %in% c('KIRC')),]

Panel2_D <- ggplot(df2plot_pearson, aes(x=effect_size, y= abundance, size= -log(P, 10))) + 
  stat_smooth(method='lm')+
  facet_wrap(~ Modulator_type+modulator_name, scales = 'free')+
  geom_point()+
  theme_bw(base_size = 15)+
    # theme(legend.position = 'none')+
  labs(x='Power of TMB (rank)',
         y=paste('Abundance'), size='-log10(P)')+
  # stat_cor( method = 's', cor.coef.name = 'rho', size=5)+
  geom_label_repel(aes(label=(df2plot_pearson$allcancer_types), size=0.9))+
  coord_flip()
  ggsave('../Result_fgures/OS_Power_of_TMB_in_5_abu_modulators_spear.pdf',
         Panel2_D, height=10, width = 9, units = 'in', dpi = 500)

```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

